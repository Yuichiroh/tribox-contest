@(cid: String, contestName: String, contestUrl: String, firebaseappContest: String)

@defining("Contest") { title =>

<!DOCTYPE html>
<html lang="ja" ng-app="contestApp">
<head>
    @header(title, contestName)

@basejs(firebaseappContest)
@authjs(redirectLogin="", redirectLogout="", checkFirst=true)
@filterjs()
@contestjs(cid)
<script>
app.controller('ContestIndexCtrl', ['$scope', function($scope) {
    $scope.eventsDone = {};
    $scope.contestIndexLoaded = true;

    // Read personal results
    var authData = contestRef.getAuth();
    if (authData) {
        contestRef.child('contests').child('c@{cid}').once('value', function(snapContest) {
            if (snapContest.exists()) {
                var contestData = snapContest.val();
                contestData.events.forEach(function(e) {
                    contestRef.child('results').child('c@{cid}').child(e).child(authData.uid).once('value', function(snapResult) {
                        var resultData = snapResult.val();
                        $scope.$apply(function() {
                            if (!resultData) {
                                $scope.eventsDone[e] = false;
                            } else {
                                if (resultData.endAt) {
                                    $scope.eventsDone[e] = true;
                                } else {
                                    $scope.eventsDone[e] = resultData.type;
                                }
                            }
                        });
                    }, function(error) {
                        console.error(error);
                    });
                });
            } else {
                console.error('Undefined contest: @{cid}');
            }
        });
    }
}]);
</script>
</head>
<body><div class="container">
    @bodyheader(title, contestName)

    <div ng-controller="AuthCtrl"><div ng-controller="ContestCtrl"><div ng-controller="ContestIndexCtrl">
    <div ng-hide="authLoaded && contestLoaded && contestIndexLoaded">
        <i class="fa fa-spinner fa-pulse fa-2x fa-fw"></i>
        <span class="sr-only">Loading...</span>
        Loading...
    </div>
    <div ng-show="authLoaded && contestLoaded && contestIndexLoaded">

    <div ng-hide="existsContest">
        <p class="color-error">
            存在しないコンテストです。
        </p>
    </div>

    <div ng-show="existsContest">

        @authinfo()

        <h2>{{ contestData.contestName }}</h2>

        <p>
            開始 <i class="fa fa-calendar"></i>: {{ contestData.beginAt | toDate }}<br>
            終了 <i class="fa fa-calendar"></i>: {{ contestData.endAt | toDate }}
        </p>
        <p ng-if="countdown == 0">
            現在開催中のコンテストです。
        </p>
        <p ng-if="countdown < 0">
            すでに終了したコンテストです。
        </p>
        <p class="color-error" ng-if="countdown > 0">
            このコンテストはまだ開始されていません。
        </p>

        <table class="table" ng-if="0 <= countdown">
            <thead>
                <tr>
                    <th>競技種目</th>
                    <th>計測フォーマット</th>
                    <th>参加</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="e in contestData.events">
                    <td>{{ events[e].name }}</td>
                    <td>{{ events[e].method | uppercaseHead }} of {{ events[e].attempts }}</td>
                    <td>
                        <a href="/contest/@cid/{{ e | removeHead }}" ng-if="countdown == 0 && authData != null && eventsDone[e] == false">参加する</a>
                        <a href="/contest/@cid/{{ e | removeHead }}/timer" ng-if="countdown == 0 && authData != null && eventsDone[e] == 'timer'">再開する</a>
                        <a href="/contest/@cid/{{ e | removeHead }}/form" ng-if="countdown == 0 && authData != null && eventsDone[e] == 'form'">再開する</a>
                        <span ng-if="countdown == 0 && authData != null && eventsDone[e] == true">参加済みです</span>
                        <a href="@routes.HomeController.login" ng-if="countdown == 0 && authData == null">ログインして参加してください</a>
                        <span ng-if="countdown != 0">現在このコンテストには参加できません</span>
                    </td>
                </tr>
            </tbody>
        </table>

        <div ng-if="countdown < 0">
            ここに結果を表示。
        </div>

        @* <!--<p>@cid -> contestData:</p>
        <pre>{{ contestData | json }}</pre>--> *@

        @* <!--<p>inProgress / countdown:</p>
        <pre>{{ inProgress | json }}</pre>
        <pre>{{ countdown | json }}</pre>--> *@

        @* <!--<p>@cid -> scramblesData:</p>
        <pre>{{ scramblesData | json }}</pre>--> *@

        @* <!--<p>@cid -> resultsData:</p>
        <pre>{{ resultsData | json }}</pre>--> *@

        @* <!--<p>events:</p>
        <pre>{{ events | json }}</pre>--> *@

    </div></div></div></div></div>

    @bodyfooter(contestName)
</div></body>
</html>

}
