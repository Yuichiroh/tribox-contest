@(cid: String, contestName: String, contestDescription: String, contestUrl: String, firebaseappContest: String)

@defining("Contest " + cid) { title =>
@defining(contestUrl + "/contest/" + cid) { pageUrl =>

<!DOCTYPE html>
<html lang="ja" ng-app="contestApp">
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
    @header(title=title, description=contestDescription, sitename=contestName, url=pageUrl, contestUrl=contestUrl)

@basejs(firebaseappContest)
</head>
<body><div class="container">
    @bodyheader(title, contestName)

    <div ng-controller="AuthCtrl"><div ng-controller="ContestCtrl"><div ng-controller="ContestIndexCtrl">
    <div ng-hide="authLoaded && contestLoaded && contestIndexLoaded">
        <i class="fa fa-spinner fa-pulse fa-2x fa-fw"></i>
        <span class="sr-only">Loading...</span>
        Loading...
    </div>
    <div ng-show="authLoaded && contestLoaded && contestIndexLoaded">

    @authinfo()

    <div ng-hide="existsContest">
        <p class="color-error">
            存在しないコンテストです。
        </p>
    </div>

    <div ng-show="existsContest">

        <h2>{{ contestData.contestName }}</h2>

        <p>
            <i class="fa fa-calendar"></i> 開催期間: <b>{{ contestData.beginAt | toDate }}</b> ~ <b>{{ contestData.endAt | toDate }}</b>
        </p>
        <p ng-if="countdown == 0">
            現在開催中のコンテストです。
        </p>
        <p class="color-error" ng-if="countdown < 0">
            このコンテストは終了しました。
        </p>
        <p class="color-error" ng-if="countdown > 0">
            このコンテストはまだ開始されていません。
        </p>

        <p class="notice-success" ng-show="countdown == 0 && justSuspended">
            <i class="fa fa-check"></i>
            "{{ justSuspended }}" が一時中断されました。
        </p>
        <p class="notice-success" ng-show="countdown == 0 && justDone">
            <i class="fa fa-check"></i>
            "{{ justDone }}" の結果送信が完了しました。
            <a href="http://twitter.com/share?url=@{contestUrl}%2F&text={{ justDoneText }}&related=triboxContest" class="btn btn-tweet" target="_blank">
                <i class="fa fa-twitter"></i> Tweet</a>
        </p>

        <table class="table table-bordered tribox-contest" ng-if="0 <= countdown">
            <thead>
                <tr>
                    <th>競技種目</th>
                    <th>計測フォーマット</th>
                    <th>参加</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="e in contestData.events">
                    <td>{{ events[e].name }}</td>
                    <td>{{ events[e].method | uppercaseHead }} of {{ events[e].attempts }}</td>
                    <td>
                        <a href="/contest/@cid/{{ e | removeHead }}" ng-if="countdown == 0 && authData != null && eventsDone[e] == false"><i class="fa fa-play-circle"></i> 参加する</a>
                        <a href="/contest/@cid/{{ e | removeHead }}/timer" ng-if="countdown == 0 && authData != null && eventsDone[e] == 'timer'"><i class="fa fa-play-circle"></i> 再開する</a>
                        <a href="/contest/@cid/{{ e | removeHead }}/form" ng-if="countdown == 0 && authData != null && eventsDone[e] == 'form'"><i class="fa fa-play-circle"></i> 再開する</a>
                        <a href="/contest/@cid/{{ e | removeHead }}/solution" ng-if="countdown == 0 && authData != null && eventsDone[e] == 'solution'"><i class="fa fa-play-circle"></i> 再開する</a>
                        <span ng-if="countdown == 0 && authData != null && eventsDone[e] == true"><i class="fa fa-check-circle"></i> 参加済みです</span>
                        <a href="@routes.HomeController.login" ng-if="countdown == 0 && authData == null"><i class="fa fa-sign-in"></i> ログインして参加してください</a>
                        <span ng-if="countdown != 0"><i class="fa fa-ban"></i> 現在このコンテストには参加できません</span>
                    </td>
                </tr>
            </tbody>
        </table>

        <div ng-if="countdown < 0">
            <div ng-repeat="e in contestData.events">
                <h3>{{ events[e].name }}</h3>
                <p>
                    計測方法: {{ events[e].method | uppercaseHead }} of {{ events[e].attempts }}<br>
                    参加人数: {{ resultsPersons[e] }} 人
                </p>
                <table class="table table-bordered result tribox-contest">
                    <thead>
                        <tr>
                            <th>順位</th>
                            <th>獲得SP</th>
                            <th>名前</th>
                            <th>所属</th>
                            <th ng-if="e != 'e333fm' && events[e].method == 'average'">平均記録</th>
                            <th ng-if="e != 'e333fm' && events[e].method == 'best'">最高記録</th>
                            <th ng-if="e == 'e333fm'">記録</th>
                            <th ng-if="e != 'e333fm'">個々の記録</th>
                            <th ng-if="e == 'e333fm'">解答・コメント</th>
                            <th>使用キューブ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="{{ e }}-{{ $index }}" ng-repeat="r in resultsTop3[e]">
                            <td>{{ r.place }}</td>
                            <td ng-if="r.seasonPoint && r.seasonPoint != 0">{{ r.seasonPoint }}</td>
                            <td ng-if="!(r.seasonPoint) || r.seasonPoint == 0"></td>
                            <td><a href="/user/{{ r.user.username }}">{{ r.user.displayname }}</a></td>
                            <td>{{ r.user.organization | shorten10}}</td>
                            <td>{{ r.resultF }}</td>
                            <td ng-if="e != 'e333fm'">{{ r.detailsF }}</td>
                            <td ng-if="e == 'e333fm'" id="e333fm-{{ $index }}-show"><a class="cursor-pointer" ng-click="showDetail($index)">表示</a></td>
                            <td ng-show="r.puzzle.type == 'database'">
                                <a href="http://store.tribox.com/products/detail.php?product_id={{ r.puzzle.product }}" target="_blank">{{ r.puzzleF }}</a>
                            </td>
                            <td ng-show="r.puzzle.type == 'nodatabase' || r.puzzle.type == 'unknown'">
                                {{ r.puzzleF }}
                            </td>
                        </tr>
                    </tbody>
                </table>
                <p>
                    <a class="btn" href="/contest/result/@{cid}/{{ e | removeHead }}">
                        {{ events[e].name }} のすべての結果を見る
                    </a>
                </p>
                @* <!--<pre>{{ resultsData[e] | json }}</pre>--> *@
                @* <!--<pre>{{ resultsTop3[e] | json }}</pre>--> *@
            </div>
        </div>

        @* <!--<p>@cid -> contestData:</p>
        <pre>{{ contestData | json }}</pre>--> *@

        @* <!--<p>inProgress / countdown:</p>
        <pre>{{ inProgress | json }}</pre>
        <pre>{{ countdown | json }}</pre>--> *@

        @* <!--<p>@cid -> scramblesData:</p>
        <pre>{{ scramblesData | json }}</pre>--> *@

        @* <!--<p>@cid -> resultsData:</p>
        <pre>{{ resultsData | json }}</pre>--> *@

        @* <!--<p>events:</p>
        <pre>{{ events | json }}</pre>--> *@

    </div></div></div></div></div>

    @bodyfooter(contestName)

@authjs(redirectLogin="", redirectLogout="", checkFirst=true)
@contestjs(cid=cid, fetchScrambles=false, fetchResultsTop3=true, fetchResultsAll=false)
<script>
app.controller('ContestIndexCtrl', ['$scope', function($scope) {
    $scope.eventsDone = {};
    $scope.justSuspended = null;
    $scope.justDone = null;
    $scope.justDoneText = '';
    $scope.contestIndexLoaded = true;

    // Read personal results
    var authData = contestRef.getAuth();
    if (authData) {
        contestRef.child('contests').child('c@{cid}').once('value', function(snapContest) {
            if (snapContest.exists()) {
                var contestData = snapContest.val();
                contestData.events.forEach(function(e) {
                    contestRef.child('results').child('c@{cid}').child(e).child(authData.uid).once('value', function(snapResult) {
                        var resultData = snapResult.val();
                        $scope.$apply(function() {
                            if (!resultData) {
                                $scope.eventsDone[e] = false;
                            } else {
                                if (resultData.endAt) {
                                    $scope.eventsDone[e] = true;
                                } else {
                                    $scope.eventsDone[e] = resultData.type;
                                }
                            }
                        });
                    }, function(error) {
                        console.error(error);
                    });
                });
            } else {
                console.error('Undefined contest: @{cid}');
            }
        });

        var vars = getUrlVars();
        if (vars.suspended) {
            var qe = 'e' + vars.suspended;
            contestRef.child('events').once('value', function(snapEvents) {
                if (snapEvents.exists() && (snapEvents.val())[qe]) {
                    $scope.$apply(function() {
                        $scope.justSuspended = (snapEvents.val())[qe].name;
                    });
                }
            }, function(error) {
                console.error(error);
            });
        } else if (vars.done) {
            var qe = 'e' + vars.done;
            contestRef.child('contests').child('c@{cid}').once('value', function(snapContest) {
                var contest = snapContest.val();
                var season = '';
                if (contest.season == 1) {
                    season = '前半期';
                } else if (contest.season == 2) {
                    season = '後半期';
                }
            contestRef.child('events').once('value', function(snapEvents) {
                if (snapEvents.exists() && (snapEvents.val())[qe]) {
                    $scope.$apply(function() {
                        $scope.justDone = (snapEvents.val())[qe].name;
                        $scope.justDoneText = encodeURIComponent(
                            'tribox Contest 第' + contest.number + '節 (' + contest.year + season + ') の ' +
                            (snapEvents.val())[qe].name + ' に参加しました! 参加締切は毎週日曜21時です。'
                        );
                    });
                }
            }, function(error) {
                console.error(error);
            });
            });
        }
    }

    $scope.showDetail = function(index) {
        var html = '<tr id="fmc-detail-' + index + '" class="fmc-detail"><td colspan="7">'
                 + '<p><b>解答:</b><br>' + TriboxContest.escapeHTML($scope.resultsTop3['e333fm'][index].details[0].solution) + '</p>'
                 + '<p><b>コメント:</b><br>' + TriboxContest.escapeHTML($scope.resultsTop3['e333fm'][index].details[0].note) + '</p>';
        angular.element(document.getElementById('e333fm-' + index)).after(html);
        angular.element(document.getElementById('e333fm-' + index + '-show')).text('表示済み');
        fadeIn(document.getElementById('fmc-detail-' + index));
    };

}]);
</script>
<script type="text/javascript" src="@routes.DynamicJsController.products"></script>

</div></body>
</html>

}
}
